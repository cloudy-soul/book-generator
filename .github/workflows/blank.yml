name: CI/CD Pipeline

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main", "develop" ]
  schedule:
    # Weekly security scan on Sundays at 2 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:  # Allow manual triggers

# Environment variables shared across jobs
env:
  PYTHON_VERSION: '3.11'
  FLUTTER_VERSION: '3.16.0'
  DOCKER_REGISTRY: 'ghcr.io'
  IMAGE_NAME: '${{ github.repository }}'

# Job configurations
jobs:
  # --------------------------------------------------
  # 1. BACKEND: Python Testing & Linting
  # --------------------------------------------------
  backend-tests:
    name: Backend Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: 'backend/requirements.txt'

      - name: Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt  # Create this file with test dependencies
          pip install bandit safety black isort mypy

      - name: Verify YAML Files Exist
        run: |
          echo "Checking YAML configuration files..."
          ls -la config/
          [ -f config/books.yaml ] || exit 1
          [ -f config/rules.yaml ] || exit 1
          [ -f config/perfumes.yaml ] || exit 1
          [ -f config/drinks.yaml ] || exit 1
          echo "✅ All YAML files present"

      - name: YAML Syntax Validation
        run: |
          python -c "
          import yaml
          import os
          for file in ['books.yaml', 'rules.yaml', 'perfumes.yaml', 'drinks.yaml']:
              path = os.path.join('config', file)
              print(f'Validating {path}...')
              with open(path, 'r') as f:
                  data = yaml.safe_load(f)
                  print(f'✅ {file}: Loaded successfully (type: {type(data).__name__})')
          "

      - name: Run Python Unit Tests with Coverage
        run: |
          python -m pytest \
            tests/ \
            -v \
            --cov=app \
            --cov-report=xml \
            --cov-report=html \
            --cov-report=term \
            --cov-fail-under=80 \
            --disable-warnings

      - name: Upload Coverage Report
        uses: codecov/codecov-action@v3
        with:
          file: ./backend/coverage.xml
          flags: python
          name: python-coverage

      - name: Type Checking with MyPy
        run: |
          mypy app/ --ignore-missing-imports --strict

      - name: Code Formatting Check (Black)
        run: |
          black --check --diff app/ tests/

      - name: Import Sorting Check (isort)
        run: |
          isort --check-only --diff app/ tests/

      - name: Linting (Flake8)
        run: |
          flake8 app/ tests/ --max-line-length=88 --extend-ignore=E203,W503

      - name: Security Scan (Bandit)
        run: |
          bandit -r app/ -f json -o bandit-report.json || true
          
      - name: Upload Security Report
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: bandit-security-report
          path: backend/bandit-report.json

  # --------------------------------------------------
  # 2. FRONTEND: Flutter Testing & Linting
  # --------------------------------------------------
  frontend-tests:
    name: Flutter Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'

      - name: Show Flutter Version
        run: flutter --version

      - name: Install Flutter Dependencies
        run: flutter pub get

      - name: Analyze Flutter Code
        run: flutter analyze --fatal-infos

      - name: Run Flutter Unit Tests
        run: flutter test --coverage

      - name: Convert LCOV to XML
        uses: VeryGoodOpenSource/very_good_coverage@v2
        with:
          path: ./frontend/coverage/lcov.info

      - name: Upload Flutter Coverage
        uses: codecov/codecov-action@v3
        with:
          file: ./frontend/coverage/coverage.xml
          flags: flutter
          name: flutter-coverage

      - name: Run Flutter Integration Tests (Emulator)
        if: ${{ github.event_name == 'pull_request' }}
        run: |
          flutter emulators --launch Pixel_4_API_30
          sleep 60  # Wait for emulator to start
          flutter test integration_test/

      - name: Build Web Version
        run: flutter build web --release

      - name: Build APK (Debug)
        run: flutter build apk --debug

      - name: Build iOS (Simulator)
        if: runner.os == 'macos'
        run: flutter build ios --simulator --no-codesign

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: flutter-builds
          path: |
            frontend/build/web/
            frontend/build/app/outputs/flutter-apk/

  # --------------------------------------------------
  # 3. SECURITY: Comprehensive Security Scans
  # --------------------------------------------------
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Python Dependency Security Scan
        uses: py-actions/py-dependency-review@v0.4.0
        with:
          path: backend/requirements.txt

      - name: SAST Scan (CodeQL)
        uses: github/codeql-action/init@v2
        with:
          languages: python, javascript

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v2

      - name: Run Trivy Vulnerability Scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy Scan Results
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Check for Secrets in Code
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          extra_args: --no-update

      - name: Dependency Check (OSV Scanner)
        uses: google/osv-scanner-action@v1
        with:
          scan: true

  # --------------------------------------------------
  # 4. DOCKER: Build & Push Images
  # --------------------------------------------------
  docker-build:
    name: Docker Build & Push
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests, security-scan]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract Metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      # Build Backend Docker Image
      - name: Build Backend Docker Image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}-backend:latest
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # Build Frontend Docker Image
      - name: Build Frontend Docker Image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          tags: ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}-frontend:latest
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # --------------------------------------------------
  # 5. DEPLOYMENT: Deploy to Environments
  # --------------------------------------------------
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [docker-build]
    if: github.event_name == 'push' && github.ref == 'refs/heads/develop'
    environment:
      name: staging
      url: https://staging.yourdomain.com
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Deploy Backend to Staging
        run: |
          echo "Deploying backend to staging..."
          # Add your deployment script here
          # Example: kubectl apply -f k8s/staging/
          # Or: ssh deploy@server "cd /app && docker-compose pull && docker-compose up -d"

      - name: Deploy Frontend to Staging
        run: |
          echo "Deploying frontend to staging..."
          # Add your deployment script here

      - name: Run Smoke Tests
        run: |
          echo "Running smoke tests on staging..."
          # curl -f https://staging.yourdomain.com/health
          # Add your smoke test script

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [deploy-staging]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment:
      name: production
      url: https://yourdomain.com
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Approve Deployment
        uses: trstringer/manual-approval@v1
        with:
          secret: ${{ github.token }}
          approvers: team-leads
          minimum-approvals: 1
          issue-title: "Production Deployment Approval"
          issue-body: "Please approve deployment for commit ${{ github.sha }}"

      - name: Deploy to Production
        run: |
          echo "Deploying to production..."
          # Add your production deployment script

      - name: Run Production Health Checks
        run: |
          echo "Running health checks..."
          # Add comprehensive health checks

  # --------------------------------------------------
  # 6. QUALITY GATES: Final Status Check
  # --------------------------------------------------
  quality-gate:
    name: Quality Gate
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests, security-scan]
    if: always()
    
    steps:
      - name: Check Job Statuses
        run: |
          echo "Backend Tests: ${{ needs.backend-tests.result }}"
          echo "Frontend Tests: ${{ needs.frontend-tests.result }}"
          echo "Security Scan: ${{ needs.security-scan.result }}"
          
          if [[ "${{ needs.backend-tests.result }}" != "success" ]]; then
            echo "❌ Backend tests failed"
            exit 1
          fi
          
          if [[ "${{ needs.frontend-tests.result }}" != "success" ]]; then
            echo "❌ Frontend tests failed"
            exit 1
          fi
          
          if [[ "${{ needs.security-scan.result }}" != "success" ]]; then
            echo "⚠️ Security scan had issues (check report)"
          fi
          
          echo "✅ All quality gates passed"
