name: CI/CD Pipeline

on:
  push:
    branches: [ "main", "features" ]  # Changed from "develop" to "features"
  pull_request:
    branches: [ "main", "features" ]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'
  FLUTTER_VERSION: '3.16.0'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # --------------------------------------------------
  # CHECK WHAT FILES EXIST IN THIS COMMIT
  # --------------------------------------------------
  check-files:
    name: Check Repository Files
    runs-on: ubuntu-latest
    outputs:
      has_backend: ${{ steps.check.outputs.has_backend }}
      has_frontend: ${{ steps.check.outputs.has_frontend }}
      has_config: ${{ steps.check.outputs.has_config }}
      has_app_code: ${{ steps.check.outputs.has_app_code }}
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Check for App Directories
        id: check
        run: |
          echo "üìÅ Checking repository contents:"
          echo "Current directory: $(pwd)"
          ls -la
          echo ""
          
          # Check for backend directory with actual code
          if [ -d "backend" ] && [ -f "backend/requirements.txt" ]; then
            echo "has_backend=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Found backend/ with requirements.txt"
          else
            echo "has_backend=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è No backend app code found (only workflow files present)"
          fi
          
          # Check for frontend directory with actual code
          if [ -d "frontend" ] && [ -f "frontend/pubspec.yaml" ]; then
            echo "has_frontend=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Found frontend/ with pubspec.yaml"
          else
            echo "has_frontend=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è No frontend app code found (only workflow files present)"
          fi
          
          # Check for config directory with YAML files
          if [ -d "config" ] && ls config/*.yaml >/dev/null 2>&1; then
            echo "has_config=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Found config/ with YAML files"
          else
            echo "has_config=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è No config YAML files found"
          fi
          
          # Overall app code check
          if [ "$has_backend" == "true" ] || [ "$has_frontend" == "true" ] || [ "$has_config" == "true" ]; then
            echo "has_app_code=true" >> $GITHUB_OUTPUT
          else
            echo "has_app_code=false" >> $GITHUB_OUTPUT
          fi
          
          echo ""
          echo "üìä Summary:"
          echo "  has_backend: ${{ steps.check.outputs.has_backend }}"
          echo "  has_frontend: ${{ steps.check.outputs.has_frontend }}"
          echo "  has_config: ${{ steps.check.outputs.has_config }}"
          echo "  has_app_code: ${{ steps.check.outputs.has_app_code }}"

  # --------------------------------------------------
  # 1. BACKEND TESTS - ONLY RUN IF BACKEND CODE EXISTS
  # --------------------------------------------------
  backend-tests:
    name: Backend Tests
    runs-on: ubuntu-latest
    needs: check-files
    if: needs.check-files.outputs.has_backend == 'true'
    timeout-minutes: 15
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install Dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov flake8

      - name: Run Tests
        working-directory: ./backend
        run: |
          if [ -d "tests" ]; then
            python -m pytest tests/ -v --cov=./ --cov-report=term --junitxml=test-results.xml
          else
            echo "‚ö†Ô∏è No tests directory found"
            exit 1
          fi

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: python-test-results
          path: backend/test-results.xml
          retention-days: 7

  # --------------------------------------------------
  # 2. FRONTEND TESTS - ONLY RUN IF FRONTEND CODE EXISTS
  # --------------------------------------------------
  frontend-tests:
    name: Flutter Tests
    runs-on: ubuntu-latest
    needs: check-files
    if: needs.check-files.outputs.has_frontend == 'true'
    timeout-minutes: 20
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'

      - name: Get Dependencies
        working-directory: ./frontend
        run: flutter pub get

      - name: Run Tests
        working-directory: ./frontend
        run: |
          if [ -d "test" ]; then
            flutter test --machine > test-results.json
          else
            echo "‚ö†Ô∏è No test directory found"
            exit 1
          fi

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: flutter-test-results
          path: frontend/test-results.json
          retention-days: 7

  # --------------------------------------------------
  # 3. CONFIG VALIDATION - ONLY RUN IF CONFIG EXISTS
  # --------------------------------------------------
  config-validation:
    name: Validate YAML Configs
    runs-on: ubuntu-latest
    needs: check-files
    if: needs.check-files.outputs.has_config == 'true'
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install PyYAML
        run: pip install pyyaml
      
      - name: Validate YAML Files
        working-directory: ./config
        run: |
          python -c "
import yaml
import os
import glob
import sys

exit_code = 0
yaml_files = glob.glob('*.yaml') + glob.glob('*.yml')

if not yaml_files:
    print('‚ùå No YAML files found')
    sys.exit(1)

print(f'Found {len(yaml_files)} YAML files')
for file_path in yaml_files:
    print(f'\\nValidating {file_path}...')
    try:
        with open(file_path, 'r', encoding='utf-8') as f:
            data = yaml.safe_load(f)
        print(f'  ‚úÖ Valid')
    except yaml.YAMLError as e:
        print(f'  ‚ùå YAML Error: {e}')
        exit_code = 1
    except Exception as e:
        print(f'  ‚ùå Error: {e}')
        exit_code = 1
sys.exit(exit_code)
"

  # --------------------------------------------------
  # 4. SECURITY SCAN - ALWAYS RUNS (OPTIONAL)
  # --------------------------------------------------
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: check-files
    if: always()  # Always run this job
    timeout-minutes: 10
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Security Tools
        run: |
          pip install bandit safety

      - name: Scan Backend Code (if exists)
        if: needs.check-files.outputs.has_backend == 'true'
        continue-on-error: true
        run: |
          bandit -r backend/ -f json -o bandit-report.json || true

      - name: Check Python Dependencies (if exists)
        if: needs.check-files.outputs.has_backend == 'true'
        continue-on-error: true
        run: |
          safety check -r backend/requirements.txt --json > safety-report.json || true

      - name: TruffleHog Secrets Scan
        uses: trufflesecurity/trufflehog@v3.81.0
        continue-on-error: true
        with:
          path: ./
          extra_args: --only-verified --max-depth=3  # Removed --no-update flag

  # --------------------------------------------------
  # 5. QUALITY GATE - ADAPTIVE BASED ON WHAT EXISTS
  # --------------------------------------------------
  quality-gate:
    name: Quality Gate
    runs-on: ubuntu-latest
    needs: [check-files, backend-tests, frontend-tests, config-validation, security-scan]
    if: always()
    
    steps:
      - name: Check Job Statuses
        run: |
          echo "==================================="
          echo "üìä QUALITY GATE REPORT"
          echo "==================================="
          echo ""
          echo "üìÅ Repository Contents:"
          ls -la | sed 's/^/    /'
          echo ""
          
          echo "üîç App Code Detection:"
          echo "  Backend code: ${{ needs.check-files.outputs.has_backend }}"
          echo "  Frontend code: ${{ needs.check-files.outputs.has_frontend }}"
          echo "  Config files: ${{ needs.check-files.outputs.has_config }}"
          echo ""
          
          FAILED=false
          TESTS_RAN=false
          
          # Check backend tests (only if backend should exist)
          if [ "${{ needs.check-files.outputs.has_backend }}" == "true" ]; then
            TESTS_RAN=true
            if [[ "${{ needs.backend-tests.result }}" != "success" ]]; then
              echo "‚ùå Backend tests FAILED (required because backend/ exists)"
              FAILED=true
            else
              echo "‚úÖ Backend tests PASSED"
            fi
          else
            echo "‚è≠Ô∏è Backend tests skipped (no backend code)"
          fi
          
          # Check frontend tests (only if frontend should exist)
          if [ "${{ needs.check-files.outputs.has_frontend }}" == "true" ]; then
            TESTS_RAN=true
            if [[ "${{ needs.frontend-tests.result }}" != "success" ]]; then
              echo "‚ùå Frontend tests FAILED (required because frontend/ exists)"
              FAILED=true
            else
              echo "‚úÖ Frontend tests PASSED"
            fi
          else
            echo "‚è≠Ô∏è Frontend tests skipped (no frontend code)"
          fi
          
          # Check config validation (only if config should exist)
          if [ "${{ needs.check-files.outputs.has_config }}" == "true" ]; then
            TESTS_RAN=true
            if [[ "${{ needs.config-validation.result }}" != "success" ]]; then
              echo "‚ùå Config validation FAILED (required because config/ exists)"
              FAILED=true
            else
              echo "‚úÖ Config validation PASSED"
            fi
          else
            echo "‚è≠Ô∏è Config validation skipped (no config files)"
          fi
          
          # Security scan (non-blocking)
          if [[ "${{ needs.security-scan.result }}" == "failure" ]]; then
            echo "‚ö†Ô∏è Security scan found issues (non-blocking)"
          elif [[ "${{ needs.security-scan.result }}" == "success" ]]; then
            echo "‚úÖ Security scan PASSED"
          else
            echo "‚ÑπÔ∏è Security scan: ${{ needs.security-scan.result }}"
          fi
          
          echo ""
          echo "==================================="
          
          # If no tests ran at all (first commit with only workflow files)
          if [ "$TESTS_RAN" == "false" ]; then
            echo "‚ÑπÔ∏è No app code detected - this is expected for initial CI setup"
            echo "‚úÖ Pipeline passed (only workflow files present)"
            exit 0
          fi
          
          if [[ "$FAILED" == "true" ]]; then
            echo "üö´ QUALITY GATE FAILED"
            exit 1
          else
            echo "‚úÖ QUALITY GATE PASSED"
            exit 0
          fi
